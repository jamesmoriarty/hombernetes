#!/bin/sh -ex

KUBECONFIG=/etc/rancher/k3s/k3s.yaml

# https://k3s.io/
curl -sfL https://get.k3s.io | sh -

# https://github.com/rancher/k3s/issues/389
sudo chmod 644 /etc/rancher/k3s/k3s.yaml

# https://k3s.io/
k3s kubectl get node

# Refinment: use user home host storage:

sudo mkdir -p /var/k8s-gitops/
sudo ln -sf /var/k8s-gitops/ "$HOME/Downloads"

# Refinement: aliases:
#
cat <<-EOF > ~/.bash_aliases
alias kubectl=' k3s kubectl'
alias k='kubectl'
alias kgp='kubectl get pods'
EOF

. ~/.bash_aliases

curl -s https://toolkit.fluxcd.io/install.sh | sudo bash

# Bugfix: Prerequisites.
# ✔ kubectl >=1.18.0
# ✔ Kubernetes  >=1.16.0
# ✔ prerequisites checks passed

sudo snap install kubectl --classic

flux --kubeconfig=/etc/rancher/k3s/k3s.yaml check --pre 

flux --kubeconfig=/etc/rancher/k3s/k3s.yaml bootstrap github \
  --owner=$GITHUB_USER \
  --repository=k8s-gitops \
  --branch=main \
  --path=cluster \
  --personal
